---
title: "OIP Postprocess Part 2"
author: "Paul Leiby and Rocio Uria"
date: "2023-05-02"
output:
  word_document: default
  html_document: default
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```

# **DRAFT**

----------------------------------------------------------------------

### Part II. After Gathering Results, Produce Summary Tables and Graphs

Can be run (from restart or cleared environment) after various sets of OIP
simulation cases have been compiled into one CSV file and saved,
by previously running `oil_postprocess.Rmd`.

```{r message=F}
suppressPackageStartupMessages(library(tidyverse))
library(here) # to locate files and directories in project
library(readxl) # for read_excel, reading Excel workbooks
library(writexl)

suppressPackageStartupMessages(library(knitr)) # for kable
# library(kableExtra)
library(flextable) # for more flexibly formatted tables
```

## Data Section

#### Expected location of input data (result files from past runs of OIP)

Locations of input and outputs are all relative to location of project directory.

```{r}
input_subpath <- "Output" # where we expect CSV file compiling all results
input_filename <- "all_rslts.csv" # expected name of CSV file generated by "oip_postprocess.Rmd"
output_subpath <- "Output" # destination for any output
AEOData_path <- "../../Data/AEO2023"
AEOData_filename <- "AEO2023_yearbyyear_Reference(PLrevision_with_checks_20230428).xlsx"
AEOData_sheetnames <- c("AEO2022ref_out", "AEO2023ref_out")

save_results_to_files <- F # TRUE
```

#### Specify set of OIP Runs to be Processed

```{r echo = T}
model_versionyears <- c("OIP2022", "OIP2023")
model_subversions <- c("v31", "v32") # each goes with the corresponding model_versionyear
```

### Execution Section

```{r}

table_title <- "New ORNL Oil Security Premiums Runs Using the AEO 2022"

table_subtitles <- c("Case", "Conditions Represented", "Disruption Premium Total (2021$)")

runset_labels <- tribble(
  ~Case, ~Label,
  1, "Run One: No Shale Oil Considered",
  2, "Run Two: Shale Oil Considered",
  3, "Run Three:  New Elasticities (NHTSA/Brown)/no shale oil considered",
  4, "Run Four: New Elasticities /Shale Oil Considered"
)

runset_assumptions <- tribble(
  ~Case, ~"SR Oil Price Elas of demand", ~"Elas of GDP to Oil Price",  ~"SR Conventional Oil Supply elas", ~"OPEC Oil Price Elas of Supply", ~"SR Shale Oil Supply Price Elas",
  1, -0.07 ,  -0.021,   0.06,   "ORNL assumption",  "Not applicable (Base=Conventional)",
  2, -0.07 ,  -0.021,   0.06,   "ORNL assumption",  "0.12 (higher)",
  3, -0.175,  -0.018,   0.06,   "ORNL assumption",  "Not applicable (Base=Conventional)",
  4, -0.175,  -0.018,   0.06,   "ORNL assumption",  "0.12 (higher)"
)

runset_labels_short <- tribble(
  ~Case, ~Label,
  1, "No Shale Oil Considered",
  2, "Shale Oil Considered",
  3, "New Elasticities",
  4, "New Elasticities/Shale Oil"
)

result_years = c(2023, 2024, 2025, 2026, 2030, 2035, 2040, 2045, 2050)

result_columnheadings <- c(
  "Short-Run Oil Price Elasticity of demand",
  "Elasticity of GDP to Oil Price",
  "Short-run Conventional Oil Supply elasticity",
  "OPEC Oil Price Elasticity of Supply",
  "Short-Run Shale Oil Supply Price Elasticity",
  "Source/Notes",
  "Result",
  as.character(result_years)
)

results_wanted <- c("Mean", "90% Confidence Interval") # For Disruption Premium Total
```

Get historical and projected GDP Deflator from AEO

```{r defFn_read_AEO_data, warning=FALSE, message=FALSE}
read_AEO_data <- function(data_path, data_filename, AEO_year_num) {

  suppressMessages(
    AEO_data_read <- read_excel(here::here(data_path, data_filename), 
                                          sheet = AEOData_sheetnames[AEO_year_num], # col_types = "text",
                             skip = 12)
  )
  
  AEO_data_read <- AEO_data_read %>% select(-c(2,3,4,5, ncol(AEO_data_read))) %>% # Last col badly named (non ASCII char)
    janitor::remove_empty(which = c("cols", "rows"))
  
  AEO_data_read <- AEO_data_read %>%
    filter(!if_all(-Indicators, is.na)) %>% # drop rows if blank exceot for Indicators column
    mutate(
      Indicators = str_trim(Indicators, side = c("both"))
    ) %>% 
    mutate(across(.cols = `2016`:`2050`, as.numeric))
  AEO_data_read
}
```


```{r warning=FALSE, message=FALSE}
AEO2023_data <- read_AEO_data(
  data_path = AEOData_path, 
  data_filename = AEOData_filename, 
  AEO_year_num = 2)

AEO2022_data <- read_AEO_data(
  data_path = AEOData_path, 
  data_filename = AEOData_filename, 
  AEO_year_num = 1)
## AEO2023_data %>% glimpse()

key_AEOData_series <- c(
  "GDP Chain-type Price Index (2012=1.000)",
  "Real Gross Domestic Product",
  "Brent Spot",
  # "United States (50 states)", # problem is that there are 3 series with ""United States (50 states)" label
  "U.S. Tight Oil Supply (Table 14)",
  "Total Liquids Consumption",
  "OPEC Liquids Market Share (percent)"
)
```


```{r defFn_gather_key_AEO_data, warning=FALSE, message=FALSE}
gather_key_AEO_data <- function(df, key_series) {
  key_data <- df %>%
    filter(Indicators %in% key_series) %>% 
    unique() #
  
  # WARNING: ToDo: Need better/safer way to drop 2nd row of Brent Spot
  key_data <- key_data[-4, ] 
  
  key_data <- key_data %>%
    pivot_longer(cols = -Indicators) %>% # this is essentially a transform
    rename(Year = name) %>% 
    pivot_wider(names_from = Indicators, values_from = value) %>%
    rename(
      deflator2012 = `GDP Chain-type Price Index (2012=1.000)`,
      US_Real_GDP = `Real Gross Domestic Product`,
      Brent_Spot = `Brent Spot`,
      US_Tight_Oil_Supply = `U.S. Tight Oil Supply (Table 14)`,
      Total_Liquids_Consumption = `Total Liquids Consumption`,
      OPEC_Supply_Share = `OPEC Liquids Market Share (percent)`
    )
  
  # necessary because there are both real and # nominal Brent Spot (works on Mac, Errs on Windows)
  # key_AEO2023_data <- key_AEO2023_data %>% unnest_wider(Brent_Spot) %>%
  #   rename(
  #     Brent_Spot_real = `...1`,
  #     Brent_Spot_nom = `...2`
  #   )

}
```


```{r gather_key_AEO_data, warning=FALSE, message=FALSE}
key_AEO2023_data <- gather_key_AEO_data(df = AEO2023_data, key_AEOData_series) %>% 
  mutate(AEOyear = "AEO2023")
key_AEO2022_data <- gather_key_AEO_data(df = AEO2022_data, key_AEOData_series) %>% 
  mutate(AEOyear = "AEO2022")
```


```{r warning=FALSE, message=FALSE}

GDPdeflator_2012 <- key_AEO2023_data %>%
  select(Year, deflator2012) %>%
  mutate(across(.cols = everything(), as.numeric)) %>%
  janitor::remove_empty("rows") 
```


```{r defFn_plot_AEO_series_comparison}
plot_AEO_series_comparison <- function(series_wanted, yunits = "value") {
  key_AEO_data %>% 
    filter(name == series_wanted) %>% 
    mutate(Year = as.numeric(Year)) %>% 
    ggplot(aes(x = Year, y = value, color = AEOyear, shape = AEOyear)) +
      geom_line() +
      geom_point(size = 3) +
    ggtitle(paste0("Comparison of AEO Data for ", series_wanted)) +
    ylab(yunits)
}
```

```{r defFn_my_regulartable}
my_regulartable <- function(df, caption = "Table", compact = F) {
  # function for standardized, reasonably-formatted tables
  if (compact) {
    my_compact_regulartable(df, caption = caption)
  } else {
    df %>% 
      regulartable() %>% # requires `flextable` package
      autofit() %>%
      set_caption(caption = caption) %>%
      theme_vanilla() %>%
      fit_to_width(max_width = 7) # max width in inches
  }
    # add_footer_lines(ft, "Footer")
    # color(ft, part = "footer", color = "#666666")
   # See: https://ardata-fr.github.io/flextable-book/  Intro
}

my_compact_regulartable <- function(df, caption = "Table") {
  # function for standardized, reasonably-formatted tables
  df %>% 
    regulartable() %>% # requires `flextable` package
    autofit() %>%
    set_caption(caption = caption) %>%
    fit_to_width(max_width = 7) # max width in inches
    # add_footer_lines(ft, "Footer")
    # color(ft, part = "footer", color = "#666666")
    # See: https://ardata-fr.github.io/flextable-book/  Intro
    # set_flextable_defaults(
    #   font.size = 10, theme_fun = theme_vanilla,
    #   padding = 6,
    #   background.color = "#EFEFEF")
}
```


Supplement Historical GDP Deflator with Early Year Values from FRED

```{r}
GDP_deflator_2012_FRED <-  # (implicit price deflator), Index 2012=1.0, FRED, Annual, Not Seasonally Adjusted
  tibble(deflator2012FRED = c( # 2000 - 2021
    0.78025,
    0.79783,
    0.81026,
    0.82625,
    0.84843,
    0.87504,
    0.90204,
    0.92642,
    0.94419,
    0.95024,
    0.96166,
    0.98164,
    1,
    1.01751,
    1.03654,
    1.04691,
    1.0574,
    1.07747,
    1.10321,
    1.12294,
    1.13648,
    1.1837 
  ))
GDP_deflator_2012_FRED$Year = 2000:2021
```


```{r}
# Combine early years of FRED deflator data with later years from AEO (overlapping year match well)
GDPdeflator_2012 <- GDPdeflator_2012 %>% 
  full_join(GDP_deflator_2012_FRED, by = "Year") %>%
  arrange(Year)

GDPdeflator_2012 <- GDPdeflator_2012 %>% 
  mutate(
    deflator2012 = ifelse(Year<2016, deflator2012FRED, deflator2012)
  ) %>%
  select(-deflator2012FRED)

GDPdeflator_2012 %>%
  filter(Year <= 2023) %>% 
  mutate(Year = as.character(Year)) %>% 
  my_regulartable(caption = "Table D1: US GDP Deflator (from AEO and FRED", compact = T)
```

```{r}
convert_year_dollars <- function(fromyear, toyear) {
  # return multiplier to convert real dollar values in `fromyear` dollars to `toyear` dollars
  multiplier <- (GDPdeflator_2012$deflator2012[GDPdeflator_2012$Year == toyear]) / (GDPdeflator_2012$deflator2012[GDPdeflator_2012$Year == fromyear])
  multiplier
}
```


```{r}
# Establish Base year dollar (numeraire year for real prices)
year_dollar = 2022

# factors to convert from various years to base year_dollar
# (could call the function later, but these constants may be cleaner)
multiplier2003toBaseyear_dollar <- convert_year_dollars(2003, year_dollar)
multiplier2012toBaseyear_dollar <- convert_year_dollars(2012, year_dollar)
multiplier2021toBaseyear_dollar <- convert_year_dollars(2021, year_dollar)
multiplier2022toBaseyear_dollar <- convert_year_dollars(2022, year_dollar)
```

## Review Assumptions from AEO2023/IEO2021, Compared to AEO2022/IEO2021

```{r combineAndNormalizeAEOdata}
key_AEO_data <- bind_rows(key_AEO2022_data, key_AEO2023_data)

# convert all prices and GDP) to base_year (2022) Dollars
key_AEO_data <- key_AEO_data %>%
  mutate(
    US_Real_GDP = US_Real_GDP * multiplier2012toBaseyear_dollar,
    Brent_Spot = ifelse(AEOyear == "AEO2022", Brent_Spot * multiplier2021toBaseyear_dollar,
                        ifelse(AEOyear == "AEO2023", Brent_Spot * multiplier2022toBaseyear_dollar,
                               NA) # unknown AEOyear
    )
  )

key_AEO_data <- key_AEO_data %>% 
  pivot_longer(cols = -c(Year, AEOyear))

```

```{r fig.width=7, fig.height=4}
series_wanted <- "US_Real_GDP"
yunits <- paste0("Billion $/yr (", year_dollar, "$)")
plot_AEO_series_comparison(series_wanted, yunits = yunits)
```

```{r fig.width=7, fig.height=4}
series_wanted <- "US_Tight_Oil_Supply"
plot_AEO_series_comparison(series_wanted, yunits = "MMBD")
```

```{r fig.width=7, fig.height=4}
series_wanted <- "Brent_Spot"
yunits <- paste0("$/bbl (", year_dollar, "$)")
plot_AEO_series_comparison(series_wanted, yunits)
```



```{r fig.width=7, fig.height=4}
series_wanted <- "OPEC_Supply_Share"
plot_AEO_series_comparison(series_wanted, yunits = "Percent of World")
```

## Read in the Results from Prior OIP Cases and Produce Tables and Graphs

Note that the financial values (\$/bbl premia) in these saved
OIP case result files are all in 2003\$.


```{r message = F}
all_rslts <- read_csv(here(output_subpath, input_filename))
# glimpse(all_rslts)
```

Summarize the Observed Variables Read, by Model and Case

```{r}
all_rslts %>% 
  rename(Case = runset_num) %>% 
  count(model_subversion, Case) %>%
  my_regulartable(caption = "Table: Observed Run Variables by Case and Model Version/AEO", compact = T)
```


Extract Key Statistics (Mean and CI bounds) for the Disruption Premium Components, 
and convert to Base Year Dollars

```{r create_disr_prems_df}
stats_wanted <- c("Mean", "5th Percentile", "95th Percentile")
# series_wanted <- c(Variable, Year, pi_d_opt)

disr_prems <- all_rslts %>% 
  select(Variable, Year, pi_d_Opt, model_versionyear, model_subversion, runset_num) %>% # focus on only total disruption premium
  filter(Variable %in% stats_wanted) %>%
  rename(Case = runset_num) %>% 
  mutate(
    Case = as.factor(Case),
    AEOyear = str_remove(model_versionyear, "OIP"),
    # Convert the Disruption Premiums from 2003 Dollars to specified Base year Dollars
    pi_d_Opt = pi_d_Opt * multiplier2003toBaseyear_dollar
  )

```

## The Cases Considered

```{r}
runset_labels %>% 
  my_regulartable(caption = "Table D2: Set of Cases Considered for Each AEO (2022 and 2023)")
```

```{r}
runset_assumptions %>% 
  my_regulartable(caption = "Table D3: Assumptions for Cases")
```

## Plot the Results For AEO2023/IEO 2021 Cases

```{r plotOneModelVersion, fig.width=7, fig.height=4}
model_version_wanted <- "v32"
AEOyear_wanted <- "2023"

disr_prems %>% 
  left_join(mutate(runset_labels_short, Case = as.character(Case)), by = "Case") %>% 
  unite(Case, c(Case, Label), sep = ": ") %>% 
  filter(Variable == "Mean") %>% 
  filter(
    model_subversion == model_version_wanted,
    AEOyear == AEOyear_wanted
    ) %>%
  group_by(Case) %>% 
  ggplot(aes(x = Year, y = pi_d_Opt, group = Case,
             color = Case)) + geom_line() + geom_point(size = 3) +
  ylab(paste0("$/bbl (", year_dollar, "$)")) +
  ggtitle(paste0("Oil Disruption Premium, AEO", AEOyear_wanted, ", Model version ", model_version_wanted))
```


## Disruption Premium Results, For Both Year AEOs (`r year_dollar` $)

```{r}
disr_prems %>%
  left_join(mutate(runset_labels_short, Case = as.character(Case)), by = "Case") %>% 
  unite(Case, c(Case, Label), sep = ": ") %>% 
  filter(
    # model_subversion == model_version_wanted,
    # AEOyear == AEOyear_wanted
    Variable == "Mean"
    ) %>% 
  select(-Variable) %>% 
  mutate(
    pi_d_Opt = round(pi_d_Opt, 2)
  ) %>% 
  pivot_wider(values_from = pi_d_Opt, 
              # id_cols = c(model_versionyear, model_subversions, AEOyear, Case),
              names_from = Year) %>%
  select(-c(model_versionyear, model_subversion)) %>% 
  my_regulartable(caption = paste0("Table R1: Mean Disruption Premium, ", year_dollar, "$ (4 Cases, 2 AEOs)"))

```


## Disruption Premium Results As a Table, For Both Year AEOs (2021$)

As a check, the values below match those presented last year for AEO2022/IEO2021 cases.

```{r}
multiplier2022to2021 <- convert_year_dollars(2022, 2021)

disr_prems %>%
  left_join(mutate(runset_labels_short, Case = as.character(Case)), by = "Case") %>% 
  unite(Case, c(Case, Label), sep = ": ") %>% 
  filter(
    # model_subversion == model_version_wanted,
    # AEOyear == AEOyear_wanted
    Variable == "Mean"
    ) %>% 
  select(-Variable) %>% 
  mutate(
    pi_d_Opt = round(pi_d_Opt * multiplier2022to2021, 2)
  ) %>% 
  pivot_wider(values_from = pi_d_Opt, 
              # id_cols = c(model_versionyear, model_subversions, AEOyear, Case),
              names_from = Year) %>%
  select(-c(model_versionyear, model_subversion)) %>% 
  my_regulartable(caption = "Table R2: Mean Disruption Premium, 2021$ (4 Cases, 2 AEOs)")

```

## Plot 2 Sets of Cases Across AEO Years for Comparison

```{r plot2SetsOfPrems, fig.width=7, fig.height=4}
disr_prems %>% 
  left_join(mutate(runset_labels_short, Case = as.character(Case)), by = "Case") %>% 
  unite(Case, c(Case, Label), sep = ": ") %>% 
  # filter(
  #   model_subversion == model_version_wanted,
  #   AEOyear == AEOyear_wanted
  # ) %>%
  select(-c(model_subversion, model_versionyear)) %>% 
  filter(Variable == "Mean") %>% 
  group_by(Case) %>% 
  ggplot(aes(x = Year, y = pi_d_Opt, group = interaction(Case, AEOyear),
             color = Case, shape = AEOyear)) + geom_line() + geom_point(size = 3) +
        ylab(paste0("$/bbl (", year_dollar, "$)")) +
        ggtitle(paste0("Oil Disruption Premium, AEO", AEOyear_wanted, ", Model version ", model_version_wanted))
```

## Look at Results for AEO2023, with Confidence Bands

The 90% Confidence Interval (CI) bounds are fairly wide.

```{r plotOneModelVersionWithCI, fig.width=7, fig.height=4}
model_version_wanted <- "v32"
AEOyear_wanted <- "2023"

disr_prems %>% 
  left_join(mutate(runset_labels_short, Case = as.character(Case)), by = "Case") %>% 
  unite(Case, c(Case, Label), sep = ": ") %>% 
  # filter(Variable == "Mean") %>% 
  filter(
    model_subversion == model_version_wanted,
    AEOyear == AEOyear_wanted
  ) %>%
  pivot_wider(names_from = Variable, values_from = pi_d_Opt)  %>% 
  group_by(Case) %>% 
  ggplot(aes(x = Year, y = Mean, 
             ymin = `5th Percentile`, ymax = `95th Percentile`, fill = Case, 
             group = Case,
             color = Case)
         ) + 
        geom_line(linewidth = 2) + 
        geom_point(size = 3) +
        geom_ribbon(alpha = 0.2) + 
        ylab(paste0("$/bbl (", year_dollar, "$)")) +
  ggtitle(paste0("Oil Disruption Premium, AEO", AEOyear_wanted, ", Model version ", model_version_wanted))
```

## Save the Disruption Premiums, in Base Year `r year_dollar` Dollars, to CSV File

```{r showDisruptionPremiumResultData}
disr_prems_out <- disr_prems %>% 
  left_join(mutate(runset_labels_short, Case = as.character(Case)), by = "Case") %>% 
  rename(DisruptionPremium = pi_d_Opt) %>% 
  pivot_wider(names_from = Year, values_from = DisruptionPremium) %>% 
  select(AEOyear, Case, Label, Variable, model_versionyear, model_subversion, everything()) %>% 
  arrange(AEOyear, Case, Variable)

round_to_2digits <- function(x) {round(x, 2)}

disr_prems_out %>% 
  unite(Case, c(Case, Label), sep = ": ") %>% 
  mutate(
    Variable = str_replace_all(Variable, "th Percentile", "th %ile")
  ) %>% 
  mutate(across(`2023`:`2050`, round_to_2digits)) %>% 
  select(-model_versionyear, -model_subversion) %>% 
  my_regulartable(caption = "Table R3: Disruption Premium Mean and CIs, 2022$ (4 Cases, 2 AEOs)") # %>% 
  # kable_styling(font_size = 7) %>% 
  # kable_classic_2(full_width = F)
```


```{r saveDisruptionPremiumResultData}
if (save_results_to_files) {
  disr_prems_out %>% 
    write_csv(file = here(output_subpath, "OIP_Disruption_Premiums_20230502.csv"))
  
  disr_prems_out %>% 
    write_xlsx(path = here(output_subpath, "OIP_Disruption_Premiums_20230502.xlsx"))
}
```

